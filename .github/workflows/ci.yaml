on: push
name: Continuous Integration
jobs:
  build:
    name: PyTest
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
    - name: Set up Python 3.12
      uses: actions/setup-python@b64ffcaf5b410884ad320a9cfac8866006a109aa # v4.8.0
      with:
        python-version: '3.12'
    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    # - uses: actions/checkout@main
    # - name: docker://python:3.12
    #   uses: docker://python:3.12  # utils is currently 3.12 so we need to use 3.12 in ci

    - name: Install poetry
      env:
        POETRY_VERSION: "1.7.1"
      run: pip install poetry==${POETRY_VERSION} poetry-plugin-sort && poetry --version

    - name: Install requirements
      run: poetry install

    - name: Copy site-packages in workspace
      working-directory: ${{ github.workspace }}
      shell: bash
      run: |
        mkdir -p "${{ github.workspace }}/env/" && cp -fR $(poetry env list | poetry env info -p)/lib/python3.12/site-packages "${{ github.workspace }}/env/"

    - name: Bootstrap and run tests
      working-directory: ${{ github.workspace }}
      shell: bash
      run: poetry run ./scripts/run_tests.sh
